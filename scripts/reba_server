#!/usr/bin/env python
import rospy
from reba_optim.srv import RebaPose, RebaPoseResponse
import numpy as np
import tf
import rospkg
import transformations
from threading import Lock
import sys

class RebaServer:
    def __init__(self, rate):
        self.tf_hand = []
        self.tf_hand.append(rospy.get_param('/reba/hand_over_location/left'))
        self.tf_hand.append(rospy.get_param('/reba/hand_over_location/right'))
        self.tfl = tf.TransformListener()
        self.tfb = tf.TransformBroadcaster()
        self.rate = rospy.Rate(rate)
        self.tf_hand_over = ([0,0,0],[0,0,0,1])
        self.lock = Lock()

    def calculate_hand_over(self, tf_hip, side=0):
        # multiply the two tf
        tf_hand_over = transformations.multiply_transform(tf_hip, self.tf_hand[side])
        # transform it into vrep format by a pi/2 y rotation
        tf_vrep = ([0.,0.,0.],[0.,0.70710678,0.,0.70710678])
        tf_hand_over = transformations.multiply_transform(tf_hand_over, tf_vrep)
        with self.lock:
            self.tf_hand_over = tf_hand_over
        return tf_hand_over

    def cb_reba_request_received(self, reba_pose_req):
        # read tf from VREP to hip
        tf_hip = transformations.pose_to_list(reba_pose_req.hip_pose)
        side = reba_pose_req.prefered_hand_to_handover
        # calculate the hand_over pose
        self.calculate_hand_over(tf_hip, side=side)
        # create the Pose response
        pose = transformations.list_to_pose(self.tf_hand_over).pose
        return RebaPoseResponse(hand_over_location=pose, hand_to_handover=side)

    def publish_handover(self):
        # publish the transformation
        self.tfb.sendTransform(self.tf_hand_over[0], self.tf_hand_over[1], rospy.Time.now(), '/vrep/hand_over', '/vrep_frame')
    
    def update_handovers(self):
        # get hip pose
        if self.tfl.canTransform('/vrep_frame', '/human/hip', rospy.Time(0)):
            tf_hip = self.tfl.lookupTransform('/vrep_frame', '/human/hip', rospy.Time(0))
            # calculate the hand_over pose
            tf_right = self.calculate_hand_over(tf_hip, 0)
            tf_left = self.calculate_hand_over(tf_hip, 1)
            self.tfb.sendTransform(tf_right[0], tf_right[1], rospy.Time.now(), '/vrep/hand_over/right', '/vrep_frame')
            self.tfb.sendTransform(tf_left[0], tf_left[1], rospy.Time.now(), '/vrep/hand_over/left', '/vrep_frame')

    def run(self, continous_publish=False):
        rospy.Service('/reba/get_reba', RebaPose, self.cb_reba_request_received)
        rospy.loginfo('REBA server running...')
        if continous_publish:
            while not rospy.is_shutdown():
                self.update_handovers()
                self.rate.sleep()
        else:
            while not rospy.is_shutdown():
                self.publish_handover()
                self.rate.sleep()

if __name__ == "__main__":
    rospy.init_node('reba_server')
    reba = RebaServer(10)
    reba.run(sys.argv[1]=='True')
    